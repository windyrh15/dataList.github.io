<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product List</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .product-card {
        margin-bottom: 20px;
      }
      .product-card img {
        max-width: 100px;
        max-height: 100px;
      }
      .custom-icon {
        padding-bottom: 10px;
      }

      /* Gaya untuk modal loading */
      .loading-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .loading-modal .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 400px;
        text-align: center;
        position: relative;
      }

      .loading-modal .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        position: relative;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="mb-4">Product List</h2>

      <!-- Button trigger modal -->
      <button
        type="button"
        class="btn btn-primary mb-3"
        data-toggle="modal"
        data-target="#addProductModal"
      >
        Tambah Produk Baru
      </button>

      <!-- Tambahkan input pencarian di sini -->
      <div class="input-group mb-3">
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="Search products..."
        />
      </div>

      <!-- Add Product Modal -->
      <div
        class="modal fade"
        id="addProductModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="addProductModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addProductModalLabel">
                Tambah Produk Baru
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="add-product-form" enctype="multipart/form-data">
                <div class="form-group">
                  <label for="product">Product Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="product"
                    name="product"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="productcode">Product Code</label>
                  <input
                    type="text"
                    class="form-control"
                    id="productcode"
                    name="productcode"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="barcode">Barcode</label>
                  <input
                    type="text"
                    class="form-control"
                    id="barcode"
                    name="barcode"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="purchase_price">Purchase Price</label>
                  <input
                    type="number"
                    class="form-control"
                    id="purchase_price"
                    name="purchase_price"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="price">Price</label>
                  <input
                    type="number"
                    class="form-control"
                    id="price"
                    name="price"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="discount">Discount</label>
                  <input
                    type="number"
                    class="form-control"
                    id="discount"
                    name="discount"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="stock">Stock</label>
                  <input
                    type="number"
                    class="form-control"
                    id="stock"
                    name="stock"
                    value="0"
                  />
                </div>
                <div class="form-group">
                  <label for="file">File (Optional)</label>
                  <input
                    type="file"
                    class="form-control-file"
                    id="file"
                    name="file"
                  />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button
                type="button"
                onclick="addNewProduct()"
                class="btn btn-primary"
              >
                Submit
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Modal -->
      <div
        class="modal fade"
        id="successModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="successModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="successModalLabel">Success</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">Product successfully added.</div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
                onclick="location.reload();"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="product-list" class="row">
        <!-- Data produk akan ditampilkan di sini -->
      </div>

      <nav aria-label="Page navigation example">
        <ul id="pagination" class="pagination justify-content-center">
          <!-- Pagination akan ditampilkan di sini -->
        </ul>
      </nav>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">
              Delete Confirmation
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="deleteModalBody">
              Are you sure you want to delete this product?
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal for Delete -->
    <div
      class="modal fade"
      id="successModalDelete"
      tabindex="-1"
      role="dialog"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="successModalLabel">Success</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">Product successfully deleted.</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
              onclick="location.reload();"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Update Product Modal -->
    <div
      class="modal fade"
      id="updateModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="updateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateModalLabel">Update Product</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="updateProductForm">
              <input type="hidden" id="update-product-id" name="product_id" />
              <div class="form-group">
                <label for="update-product">Product Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="update-product"
                  name="product"
                  required
                />
              </div>
              <div class="form-group">
                <label for="update-productcode">Product Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="update-productcode"
                  name="productcode"
                  required
                />
              </div>
              <div class="form-group">
                <label for="update-barcode">Barcode</label>
                <input
                  type="text"
                  class="form-control"
                  id="update-barcode"
                  name="barcode"
                  required
                />
              </div>
              <div class="form-group">
                <label for="update-purchase_price">Purchase Price</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="update-purchase_price"
                  name="purchase_price"
                  required
                />
              </div>
              <div class="form-group">
                <label for="update-price">Price</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="update-price"
                  name="price"
                  required
                />
              </div>
              <div class="form-group">
                <label for="update-discount">Discount</label>
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="update-discount"
                  name="discount"
                />
              </div>
              <div class="form-group">
                <label for="update-stock">Stock</label>
                <input
                  type="number"
                  class="form-control"
                  id="update-stock"
                  name="stock"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateProduct()"
            >
              Update
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- loading -->

    <div id="loadingModal" class="modal">
      <div class="modal-content">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      const token = "Bearer DpacnJf3uEQeM7HN";
      const apiUrl = "https://newapi.katib.id/app/product/49";
      const apiUrlAdd = "https://newapi.katib.id/add/product";

      const productsPerPage = 9;
      let currentPage = 1;
      let totalProducts = 0;

      function renderProductCards(products) {
        const productList = document.getElementById("product-list");
        productList.innerHTML = "";

        products.forEach((product) => {
          const col = document.createElement("div");
          col.className = "col-md-4";

          const card = document.createElement("div");
          card.className = "card product-card";

          const cardBody = document.createElement("div");
          cardBody.className = "card-body";

          const icon = document.createElement("div");
          icon.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" class="bi bi-box-seam-fill" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M15.528 2.973a.75.75 0 0 1 .472.696v8.662a.75.75 0 0 1-.472.696l-7.25 2.9a.75.75 0 0 1-.557 0l-7.25-2.9A.75.75 0 0 1 0 12.331V3.669a.75.75 0 0 1 .471-.696L7.443.184l.01-.003.268-.108a.75.75 0 0 1 .558 0l.269.108.01.003zM10.404 2 4.25 4.461 1.846 3.5 1 3.839v.4l6.5 2.6v7.922l.5.2.5-.2V6.84l6.5-2.6v-.4l-.846-.339L8 5.961 5.596 5l6.154-2.461z"/>
</svg>

    `;
          icon.classList.add("custom-icon");

          const title = document.createElement("h5");
          title.className = "card-title";
          title.textContent = product.product;

          const productCode = document.createElement("p");
          productCode.className = "card-text";
          productCode.textContent = `Product Code: ${product.productcode}`;

          const barcode = document.createElement("p");
          barcode.className = "card-text";
          barcode.textContent = `Barcode: ${product.barcode}`;

          const price = document.createElement("p");
          price.className = "card-text";
          price.textContent = `Price: ${product.price}`;

          const stock = document.createElement("p");
          stock.className = "card-text";
          stock.textContent = `Stock: ${product.stock}`;

          // Tombol Update
          const updateButton = document.createElement("button");
          updateButton.className = "btn btn-primary mr-2";
          updateButton.textContent = "Update";
          updateButton.onclick = () => showUpdateModal(product);

          // Tombol Delete
          const deleteButton = document.createElement("button");
          deleteButton.className = "btn btn-danger";
          deleteButton.textContent = "Delete";
          deleteButton.onclick = () => showDeleteModal(product.product_id); // Panggil deleteProduct dengan id produk saat tombol ditekan

          cardBody.appendChild(icon);
          cardBody.appendChild(title);
          cardBody.appendChild(productCode);
          cardBody.appendChild(barcode);
          cardBody.appendChild(price);
          cardBody.appendChild(stock);
          cardBody.appendChild(updateButton);
          cardBody.appendChild(deleteButton);

          card.appendChild(cardBody);
          col.appendChild(card);
          productList.appendChild(col);
        });
      }

      async function fetchProducts(page = 1) {
        try {
          const response = await fetch(apiUrl, {
            headers: {
              Authorization: token,
            },
          });
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          const data = await response.json();
          totalProducts = data.products.length;

          const startIndex = (page - 1) * productsPerPage;
          const endIndex = startIndex + productsPerPage;
          const products = data.products.slice(startIndex, endIndex);

          renderProductCards(products);
          renderPagination();
        } catch (error) {
          console.error(
            "There has been a problem with your fetch operation:",
            error
          );
        }
      }

      function renderPagination() {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const totalPages = Math.ceil(totalProducts / productsPerPage);

        const prevLi = document.createElement("li");
        prevLi.className = "page-item";
        if (currentPage === 1) {
          prevLi.classList.add("disabled");
        }

        const prevA = document.createElement("a");
        prevA.className = "page-link";
        prevA.href = "#";
        prevA.textContent = "Previous";
        prevA.onclick = function () {
          if (currentPage > 1) {
            currentPage--;
            fetchProducts(currentPage);
          }
        };

        prevLi.appendChild(prevA);
        pagination.appendChild(prevLi);

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = "page-item";
          if (i === currentPage) {
            li.classList.add("active");
          }

          const a = document.createElement("a");
          a.className = "page-link";
          a.href = "#";
          a.textContent = i;
          a.onclick = (function (page) {
            return function () {
              currentPage = page;
              fetchProducts(page);
            };
          })(i);

          li.appendChild(a);
          pagination.appendChild(li);
        }

        const nextLi = document.createElement("li");
        nextLi.className = "page-item";
        if (currentPage === totalPages) {
          nextLi.classList.add("disabled");
        }

        const nextA = document.createElement("a");
        nextA.className = "page-link";
        nextA.href = "#";
        nextA.textContent = "Next";
        nextA.onclick = function () {
          if (currentPage < totalPages) {
            currentPage++;
            fetchProducts(currentPage);
          }
        };

        nextLi.appendChild(nextA);
        pagination.appendChild(nextLi);
      }

      function showLoadingModal() {
        document.getElementById("loadingModal").style.display = "block";
      }

      function hideLoadingModal() {
        document.getElementById("loadingModal").style.display = "none";
      }

      let filteredProducts = []; // Menyimpan produk yang sudah difilter

      async function searchProducts() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();

        try {
          const response = await fetch(apiUrl, {
            headers: {
              Authorization: token,
            },
          });
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          const data = await response.json();

          // Filter produk berdasarkan nama produk
          filteredProducts = data.products.filter((product) =>
            product.product.toLowerCase().includes(searchTerm)
          );

          renderProductCards(filteredProducts);
          renderPagination();
        } catch (error) {
          console.error(
            "There has been a problem with your fetch operation:",
            error
          );
        }
      }

      // Panggil fungsi searchProducts saat halaman dimuat pertama kali
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("searchInput")
          .addEventListener("input", debounce(searchProducts, 300));
      });

      // Debounce function untuk menunda eksekusi pencarian
      function debounce(func, delay) {
        let timer;
        return function () {
          const context = this;
          const args = arguments;
          clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(context, args);
          }, delay);
        };
      }

      async function fetchProductCount() {
        try {
          const response = await fetch(apiUrl, {
            headers: {
              Authorization: token,
            },
          });
          if (!response.ok) {
            throw new Error("Failed to fetch data");
          }
          const data = await response.json();
          totalProducts = data.products.length;
          return totalProducts;
        } catch (error) {
          console.error("Error fetching product count:", error);
          return 0;
        }
      }

      function showSuccessModal() {
        $("#successModal").modal("show");
      }

      async function addNewProduct() {
        const product = document.querySelector("#product").value;
        const productcode = document.querySelector("#productcode").value;
        const barcode = document.querySelector("#barcode").value;
        const purchase_price = document.querySelector("#purchase_price").value;
        const price = document.querySelector("#price").value;
        const discount = document.querySelector("#discount").value;
        const stock = document.querySelector("#stock").value;
        const file = document.querySelector("#file").files[0];

        try {
          // Tampilkan modal loading
          showLoadingModal();

          // Tunggu 4 detik untuk simulasi loading
          await new Promise((resolve) => setTimeout(resolve, 8000));

          // Ambil jumlah data produk untuk menentukan ID produk baru
          const dataCount = await fetchProductCount();
          const newProductId = dataCount + 1;

          const newProduct = {
            id: newProductId,
            owner_id: 49,
            product,
            productcode,
            barcode,
            category_id: 1,
            unit_id: 1,
            purchase_price: parseFloat(purchase_price),
            price: parseFloat(price),
            discount: parseFloat(discount),
            stock: parseInt(stock),
            file: file ? file.name : null,
          };

          const response = await fetch(apiUrlAdd, {
            method: "POST",
            headers: {
              Authorization: token,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(newProduct),
          });

          if (!response.ok) {
            throw new Error("Failed to add new product");
          }

          showLoadingModal();
          // Refresh daftar produk setelah penambahan berhasil
          setTimeout(() => {
            location.reload();
          }, 8000);

          fetchProducts();

          // Menutup modal dan menampilkan modal sukses
          $("#addProductModal").modal("hide");
          showSuccessModal();

          // Kosongkan form setelah submit
          // document.getElementById("add-product-form").reset();
        } catch (error) {
          console.error("Error adding new product:", error);
        }
      }

      $("#successModal").on("hidden.bs.modal", function () {
        handleSuccessModalHidden();
      });

      let currentProduct = null;

      function showUpdateModal(product) {
        currentProduct = product;
        $("#update-product").val(product.product);
        $("#update-productcode").val(product.productcode);
        $("#update-barcode").val(product.barcode);
        $("#update-purchase_price").val(product.purchase_price);
        $("#update-price").val(product.price);
        $("#update-discount").val(product.discount);
        $("#update-stock").val(product.stock);
        $("#updateModal").modal("show");
      }

      async function updateProduct() {
        if (!currentProduct) return;

        const updateUrl = `https://newapi.katib.id/data/product/${currentProduct.product_id}`;

        // Retrieve updated data from form fields
        const product = document.querySelector("#update-product").value;
        const productcode = document.querySelector("#update-productcode").value;
        const barcode = document.querySelector("#update-barcode").value;
        const purchase_price = document.querySelector(
          "#update-purchase_price"
        ).value;
        const price = document.querySelector("#update-price").value;
        const discount = document.querySelector("#update-discount").value;
        const stock = document.querySelector("#update-stock").value;

        try {
          // Tampilkan modal loading
          showLoadingModal();

          // Tunggu 4 detik untuk simulasi loading
          await new Promise((resolve) => setTimeout(resolve, 6000));

          const response = await fetch(updateUrl, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({
              product,
              productcode,
              barcode,
              purchase_price,
              price,
              discount,
              stock,
            }),
          });

          if (!response.ok) {
            throw new Error("Failed to update product");
          }

          // Refresh product list after successful update
          setTimeout(() => {
            location.reload();
          }, 6000);

          fetchProducts();

          // Close modal and show success modal
          $("#updateModal").modal("hide");
          showSuccessModal();
        } catch (error) {
          console.error("Error updating product:", error);
        }
      }

      // Fungsi untuk menampilkan modal delete
      function showDeleteModal(productId) {
        // Mengatur pesan konfirmasi penghapusan
        var deleteMessage = "Are you sure you want to delete this product?";
        document.getElementById("deleteModalBody").textContent = deleteMessage;

        // Menangani klik tombol Delete
        $("#confirmDeleteBtn")
          .off("click")
          .on("click", function () {
            // Panggil fungsi untuk menghapus produk
            deleteProduct(productId);
            // Sembunyikan modal setelah menghapus
            $("#deleteModal").modal("hide");
          });

        // Tampilkan modal delete
        $("#deleteModal").modal("show");
      }

      function showSuccessModalDelete() {
        $("#successModalDelete").modal("show");
      }

      async function deleteProduct(productId) {
        const deleteUrl = `https://newapi.katib.id/data/product/delete/${productId}`;

        try {
          // Tampilkan modal loading
          showLoadingModal();

          // Tunggu 4 detik untuk simulasi loading
          await new Promise((resolve) => setTimeout(resolve, 8000));

          const response = await fetch(deleteUrl, {
            method: "PUT",
            headers: {
              Authorization: token,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ deleted: "yes" }), // Mengubah deleted menjadi "yes"
          });

          if (!response.ok) {
            throw new Error("Failed to delete product");
          }

          // Panggil modal keberhasilan
          showSuccessModalDelete();

          // Sembunyikan modal loading setelah penghapusan berhasil
          hideLoadingModal();

          setTimeout(() => {
            location.reload();
          }, 8000);

          // Refresh daftar produk setelah penghapusan berhasil
          fetchProducts();

          // Reload halaman setelah 4 detik
        } catch (error) {
          console.error("Error deleting product:", error);
          // Sembunyikan modal loading jika terjadi error
          hideLoadingModal();
        }
      }

      fetchProducts();
    </script>
  </body>
</html>
